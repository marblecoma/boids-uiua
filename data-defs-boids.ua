# Experimental!
I ~ "git: github.com/Marcos-cat/iris"
Dims â† âŠŸ 1600 900 # width height

NumBoids      â† 500
Size          â† 6 # boid size
VelInit       â† 75
VelLimit      â† Ã— 2 VelInit
Perception    â† 40
SeparationStr â† 0.7
AlignmentStr  â† 0.5
CohesionStr   â† 0.4
ChaseStr      â† 0.01

BlinkCycle â† 3    # seconds between blinks
BlinkDur   â† 0.25 # length of blink in seconds
NormalCol  â† â†¯3 0.6
BlinkCol   â† Yellow
NudgeFlag  â† 0 # neighbors nudging timers defaults to false
NudgeAmt   â† Ã—BlinkCycle 0.01

â”Œâ”€â•´Boid
  ~ {
    Pos â† âŒŠ /â„‚ Ã—Dims [âš‚âš‚]
    Vel â† â…â‚‚ Ã—VelInit â„‚ Â°âˆ Ã—Ï„ âš‚
    Color â† NormalCol
    BlinkStart â† BlinkCycle
    BlinkEnd â† 0 # default value. This is updated to BlinkStart + BlinkDur
    Blinking â† 0 # defaults to false
    Timer â† 0    # keeps track of elapsed time since last blink
  }

  # Outputs perception matrix above boids
  # PercMat Boids ? Boids
  Perceive â† â‰¤Perception âŒµ Ë™âŠ- âŠ¸Pos

  # Updates velocities to steer away from boids within Perception radius
  # Boids Vars ? PercMat Boids Vars
  Separation â† (
    âŠ™(Ë™âŠ-âŠ¸Pos) # calc position differences between all boids
    Ã—          # zero out position differences where distance is greater than perception
    Â±/+        # calc normalized separation vectors per boid
    Ã— âŠ¡â‚€â¤™âŠ™âŠ™âˆ˜   # scale vectors
    âœVel+ :    # add steering vectors to current velocities
  )

  # Updates velocities to steer towards avg velocity of boids within Perception radius
  # Boids Vars ? PercMat Boids Vars
  Alignment â† (
    âŠ™âŠ¸Vel    # put velocities below PercMat on stack
    âŠ¸Ã—       # zero out velocity differences where distance is greater than perception
    Ã·âˆ©/+Â±âŠ¸âŒµ  # calc average velocity of boids within Perception radius per boid
    -        # difference between current vel and avg vel per boid
    Ã— âŠ¡â‚â¤™âŠ™âŠ™âˆ˜ # scale differences
    âœVelËœ- : # subtract differences from current velocities
  )

  # Updates velocities to steer towards the average position of boids within Perception radius
  # Boids Vars ? PercMat Boids Vars
  Cohesion â† (
    âŠ™âŠ¸Pos
    âŠ¸Ã—       # fill each col with positions of boids within Perception radius
    Ã·âˆ©/+Â±âŠ¸âŒµ  # calc average position of boids within Perception radius per boid
    Â±-       # calc normalized vectors pointing at avg position per boid
    Ã— âŠ¡â‚‚â¤™âŠ™âŠ™âˆ˜ # scale vectors
    âœVelËœ- : # subtract cohesion vectors from current velocities
  )

  # If Nudge flag is set, advance timers based on seeing flashes within perception radius
  # Boids Vars ? PercMat Boids Vars
  NudgeTimer â† (
    â—¡â‹…â‹…âŠ¡â‚ƒ # check Nudge Flag
    â¨¬(â—Œ
    | Ã—Ë™âŠâ‰ Â°âŠ              # remove self-checks from perception matrix
      /+ Ã—âŠ™âŠ¸Blinking      # count blinking boids within perception radius
      âœTimer+ : Ã—NudgeAmt # nudge timers forward
    )
  )

  Flock       â† NudgeTimer âŸœ(Cohesion|Alignment|Separation) Perceive
  Move        â† âœPos+ âŸœ(Ã—I~Dt âœâŒµ(â†¥ VelInit â†§ VelLimit) Vel)
  Wrap        â† âœPosâœ(âŠŸÂ°â„‚|â—¿Dims)
  UpdateTimer â† âœ(Timer|Ëœâ¥Ã—â‚€) âŠ™â‰¥ âŸœâŠƒ(BlinkEnd|Timer) âœTimer(+I~Dt)
  Blink       â† âœBlinkingâ—Œ âŠ™(Ã—âŠ“âŒŸ<â‰¥) âŸœâŠƒ(BlinkEnd|BlinkStart|Timer)
  UpdateCol   â† âœColorâ—Œ : â¨¬(NormalCol|BlinkCol) âŠ¸Blinking
  Update      â† UpdateCol Blink UpdateTimer Wrap Move Flock
  Render â† (
    I~Draw~Centered~CircleËœâŠ‚0.6BlinkCol Ã—1.25Size â–½âŠ¸âŠƒ(Blinking|Pos)
    I~Draw~Centered~SquareâŠ¸âŠƒ(Color|Size|Pos)
  )
â””â”€â•´

# create boids as struct of arrays
# boids ?
Reset â† (
  â¥(âšâŠ‚ Boid)-â‚NumBoids âšÂ¤Boid
  âœBoid~BlinkEndâ—Œ âŸœ(+BlinkDur Boid~BlinkStart) # populate BlinkEnd field
  âœBoid~Timer(Ã—BlinkCycleâˆµâ‹…âš‚)
)

[SeparationStr AlignmentStr CohesionStr NudgeFlag] # Place vars on stack
Reset                                              # Init boids
I~Open Dims "Boids"
Â°I~Screen~FPS 60

I~Loop!(
  I~Draw~Background Black
  ğ„âŒ(âœâ†™â‚ƒ+:) Ã—0.1 â‰¡/- I~Key~Pressed ["sw" "ad" "qe"] # check input to updates strs
  â¥âŠ™âœâŠ£Â¬ âŠ¢I~Key~Pressed "f"                          # check input to update nudge flag
  â¥â‹…Reset /Ã— I~Key~Down {I~Key~LeftControl @R}      # check input to reset boids
  Boid~Update
  Boid~Render
  I~Draw~Text White 50 â„‚ 10 -50 âŠ£Dims "Ctrl-r to Restart"
  I~Draw~Text White 25 â„‚ 10 -150 âŠ£Dims âŠ‚"Separation (W/S): " Â°â‹•â…â‚âŠ¡â‚€â¤™âŠ™âˆ˜
  I~Draw~Text White 25 â„‚ 10 -120 âŠ£Dims âŠ‚"Alignment (A/D): " Â°â‹•â…â‚âŠ¡â‚â¤™âŠ™âˆ˜
  I~Draw~Text White 25 â„‚ 10 -90 âŠ£Dims âŠ‚"Cohesion (Q/E): " Â°â‹•â…â‚âŠ¡â‚‚â¤™âŠ™âˆ˜
  I~Draw~Text White 25 â„‚ 10 -180 âŠ£Dims âŠ‚"Nudge (F): " â¨¬"False""True" âŠ¡â‚ƒâ¤™âŠ™âˆ˜
)
